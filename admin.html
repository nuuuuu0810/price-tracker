<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>å•†å“ç®¡ç† - Price Tracker</title>
    <style>
        body { font-family: sans-serif; max-width: 800px; margin: 0 auto; padding: 20px; background: #f0f2f5; }
        h1 { text-align: center; color: #333; }
        .card { background: white; padding: 20px; border-radius: 8px; box-shadow: 0 1px 3px rgba(0,0,0,0.1); margin-bottom: 20px; }
        label { display: block; margin-bottom: 5px; font-weight: bold; font-size: 0.9em; }
        input { width: 100%; padding: 10px; margin-bottom: 15px; border: 1px solid #ddd; border-radius: 4px; box-sizing: border-box; }
        button { cursor: pointer; border: none; padding: 10px 20px; border-radius: 4px; font-weight: bold; }
        .btn-add { background: #007bff; color: white; width: 100%; }
        .btn-save { background: #28a745; color: white; width: 100%; font-size: 1.1em; }
        .btn-del { background: #dc3545; color: white; padding: 5px 10px; font-size: 0.8em; }
        .item { border-bottom: 1px solid #eee; padding: 10px 0; display: flex; justify-content: space-between; align-items: center; }
        .item:last-child { border-bottom: none; }
        .item-info { font-size: 0.9em; }
        code { background: #eee; padding: 2px 4px; border-radius: 3px; }
        .back-link { display: block; text-align: center; margin-top: 20px; text-decoration: none; color: #666; }
    </style>
</head>
<body>
    <h1>âš™ï¸ å•†å“ç®¡ç†ãƒãƒãƒ¼ã‚¸ãƒ£ãƒ¼</h1>

    <!-- GitHubèªè¨¼è¨­å®š -->
    <div class="card">
        <h3>ğŸ”‘ GitHubè¨­å®š</h3>
        <label>Personal Access Token (Repoæ¨©é™å¿…é ˆ)</label>
        <input type="password" id="gh-token" placeholder="ghp_xxxxxxxxxxxx...">
        <label>ãƒªãƒã‚¸ãƒˆãƒª (ãƒ¦ãƒ¼ã‚¶ãƒ¼å/ãƒªãƒã‚¸ãƒˆãƒªå)</label>
        <input type="text" id="gh-repo" placeholder="example/price-tracker">
    </div>

    <!-- æ–°è¦è¿½åŠ ãƒ•ã‚©ãƒ¼ãƒ  -->
    <div class="card">
        <h3>â• æ–°è¦å•†å“è¿½åŠ </h3>
        <label>å•†å“å</label>
        <input type="text" id="new-name" placeholder="ä¾‹: Uniqlo ãƒ‘ãƒ¼ã‚«ãƒ¼">
        <label>URL</label>
        <input type="text" id="new-url" placeholder="https://...">
        <label>ä¾¡æ ¼ã‚»ãƒ¬ã‚¯ã‚¿ (CSS Selector)</label>
        <input type="text" id="new-selector" placeholder="ä¾‹: .price-state">
        <button class="btn-add" onclick="addItem()">ãƒªã‚¹ãƒˆã«è¿½åŠ  (ä¸€æ™‚çš„)</button>
    </div>

    <!-- ç¾åœ¨ã®ãƒªã‚¹ãƒˆ -->
    <div class="card">
        <h3>ğŸ“ ç›£è¦–ãƒªã‚¹ãƒˆ (æœªä¿å­˜)</h3>
        <div id="list-container">èª­ã¿è¾¼ã¿ä¸­...</div>
    </div>

    <button class="btn-save" onclick="saveToGitHub()">ğŸ’¾ GitHubã«ä¿å­˜ãƒ»åæ˜ ã™ã‚‹</button>
    
    <a href="index.html" class="back-link">â† ã‚°ãƒ©ãƒ•ç”»é¢ã«æˆ»ã‚‹</a>

    <script>
        let productList = [];

        // åˆæœŸåŒ–ï¼šã‚µãƒ¼ãƒãƒ¼ä¸Šã®ç¾åœ¨ã®ãƒªã‚¹ãƒˆã‚’å–å¾—
        async function init() {
            try {
                const res = await fetch('products.json?t=' + Date.now());
                if (res.ok) {
                    productList = await res.json();
                } else {
                    productList = [];
                }
                renderList();
            } catch (e) {
                console.error(e);
                document.getElementById('list-container').innerText = "èª­ã¿è¾¼ã¿ã‚¨ãƒ©ãƒ¼";
            }
        }

        // ãƒªã‚¹ãƒˆæç”»
        function renderList() {
            const container = document.getElementById('list-container');
            container.innerHTML = "";
            if (productList.length === 0) {
                container.innerHTML = "<p style='color:#888;text-align:center'>ãƒªã‚¹ãƒˆã¯ç©ºã§ã™</p>";
                return;
            }
            productList.forEach((item, index) => {
                const div = document.createElement('div');
                div.className = 'item';
                div.innerHTML = `
                    <div class="item-info">
                        <strong>${item.name}</strong><br>
                        <span style="color:#666;font-size:0.8em">${item.url.substring(0, 40)}...</span><br>
                        <code>${item.selector}</code>
                    </div>
                    <button class="btn-del" onclick="deleteItem(${index})">å‰Šé™¤</button>
                `;
                container.appendChild(div);
            });
        }

        // è¿½åŠ å‡¦ç†
        function addItem() {
            const name = document.getElementById('new-name').value.trim();
            const url = document.getElementById('new-url').value.trim();
            const selector = document.getElementById('new-selector').value.trim();
            if(!name || !url || !selector) return alert("å…¨ã¦ã®é …ç›®ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„");

            productList.push({ name, url, selector });
            renderList();
            
            // ãƒ•ã‚©ãƒ¼ãƒ ã‚¯ãƒªã‚¢
            document.getElementById('new-name').value = "";
            document.getElementById('new-url').value = "";
            document.getElementById('new-selector').value = "";
        }

        // å‰Šé™¤å‡¦ç†
        function deleteItem(index) {
            if(confirm("ã“ã®å•†å“ã‚’ãƒªã‚¹ãƒˆã‹ã‚‰å‰Šé™¤ã—ã¾ã™ã‹ï¼Ÿ")) {
                productList.splice(index, 1);
                renderList();
            }
        }

        // GitHub APIã¸ã®ä¿å­˜å‡¦ç†
        async function saveToGitHub() {
            const token = document.getElementById('gh-token').value.trim();
            const repo = document.getElementById('gh-repo').value.trim();

            if (!token || !repo) return alert("GitHubãƒˆãƒ¼ã‚¯ãƒ³ã¨ãƒªãƒã‚¸ãƒˆãƒªåã‚’å…¥åŠ›ã—ã¦ãã ã•ã„");
            if (!confirm("æœ¬å½“ã«GitHubä¸Šã®è¨­å®šãƒ•ã‚¡ã‚¤ãƒ«ã‚’æ›´æ–°ã—ã¾ã™ã‹ï¼Ÿ")) return;

            const apiUrl = `https://api.github.com/repos/${repo}/contents/products.json`;

            try {
                // 1. ç¾åœ¨ã®SHAã‚’å–å¾—
                const getRes = await fetch(apiUrl, {
                    headers: { "Authorization": `token ${token}` }
                });
                
                let sha = null;
                if (getRes.ok) {
                    const getData = await getRes.json();
                    sha = getData.sha;
                }

                // 2. æ—¥æœ¬èªå¯¾å¿œã®Base64ã‚¨ãƒ³ã‚³ãƒ¼ãƒ‰
                const jsonStr = JSON.stringify(productList, null, 2);
                const content = btoa(unescape(encodeURIComponent(jsonStr)));

                // 3. PUTãƒªã‚¯ã‚¨ã‚¹ãƒˆ
                const body = {
                    message: "Update products.json from Web Admin",
                    content: content
                };
                if (sha) body.sha = sha;

                const putRes = await fetch(apiUrl, {
                    method: "PUT",
                    headers: {
                        "Authorization": `token ${token}`,
                        "Content-Type": "application/json"
                    },
                    body: JSON.stringify(body)
                });

                if (putRes.ok) {
                    alert("ä¿å­˜æˆåŠŸï¼æ¬¡å›ã®è‡ªå‹•å®Ÿè¡Œã‹ã‚‰åæ˜ ã•ã‚Œã¾ã™ã€‚");
                } else {
                    const err = await putRes.json();
                    alert("ã‚¨ãƒ©ãƒ¼: " + err.message);
                }
            } catch (e) {
                alert("é€šä¿¡ã‚¨ãƒ©ãƒ¼: " + e);
            }
        }

        init();
    </script>
</body>
</html>
